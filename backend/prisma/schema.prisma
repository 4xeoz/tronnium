// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
}

//
// Enums
// 

enum AssetDomain {
  IT
  OT
  UNKNOWN
}

//
// Core Auth / User
// Youâ€™re using Google OAuth + JWT in your app.
// This schema stores the user identity and basic profile info.
//

model UserAccount {
  id             String   @id @default(uuid()) @db.Uuid

  // Primary identity (unique)
  email          String   @unique

  displayName String?
  avatarUrl   String?
  role        String   @default("user")

  // Google identity: "sub" claim is stable per Google account
  googleSubjectId  String?  @unique

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // environments   Environment[]

  @@index([createdAt])
  environments Environment[]
}



//
// Multi-tenant workspace-style structure
// User -> Environment -> Assets
// 


model Environment {
  id              String          @id @default(uuid()) @db.Uuid

  ownerId         String          @db.Uuid
  owner           UserAccount     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  name            String          // e.g. "HQ IT", "Plant A OT", "Cloud Prod"
  description     String?

  // Useful for filtering (prod/dev/lab, plant-a, region-uk)
  labels          String[]        @default([])

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  assets          Asset[]

  @@index([ownerId])
}


//
// Assets
// Simple asset model - stores user input and selected CPEs with metadata
//

model Asset {
  id            String      @id @default(uuid()) @db.Uuid

  environmentId String      @db.Uuid
  environment   Environment @relation(fields: [environmentId], references: [id], onDelete: Cascade)

  // User-entered fields
  name          String      // Asset name, e.g. "Main Firewall", "OpenSSL Server"
  description   String?     // Optional description
  
  // Asset type for visualization and categorization
  type          String      @default("unknown") // e.g., "server", "database", "network", "firewall", "iot"

  // Domain classification
  domain        AssetDomain @default(UNKNOWN)

  // Map visualization coordinates
  x             Float?      // X coordinate for map canvas positioning
  y             Float?      // Y coordinate for map canvas positioning

  // Asset metadata
  status        String?     // e.g., "active", "inactive", "maintenance", "decommissioned"
  location      String?     // Physical or logical location, e.g., "Data Center 1", "Cloud-US-East"
  ipAddress     String?     // IP address for network-connected assets
  manufacturer  String?     // Manufacturer/vendor name
  model         String?     // Model name or number
  serialNumber  String?     // Serial number or asset tag

  // CPEs selected by user with full metadata (score, breakdown, cpeNameId)
  // JSON array of: { cpeName, cpeNameId, title, score, breakdown: { vendor, product, version, tokenOverlap } }
  cpes          Json        @default("[]")

  // Optional tags for organization
  tags          String[]    @default([])

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([environmentId])
  @@index([domain])
  @@index([type])
  @@index([status])
}
